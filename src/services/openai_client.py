"""OpenAI client for generating location-based facts."""

import logging
import os
import re

import aiohttp
from openai import AsyncOpenAI

logger = logging.getLogger(__name__)


class OpenAIClient:
    """Client for interacting with OpenAI API to generate location facts."""

    def __init__(self, api_key: str | None = None):
        """Initialize OpenAI client.

        Args:
            api_key: OpenAI API key. If None, will use OPENAI_API_KEY env var.
        """
        self.client = AsyncOpenAI(api_key=api_key or os.getenv("OPENAI_API_KEY"))

    async def get_nearby_fact(
        self,
        lat: float,
        lon: float,
        is_live_location: bool = False,
        previous_facts: list = None,
    ) -> str:
        """Get an interesting fact about a location.

        Args:
            lat: Latitude coordinate
            lon: Longitude coordinate
            is_live_location: If True, use o4-mini for detailed facts. If False, use gpt-4.1 for speed.
            previous_facts: List of previously sent facts to avoid repetition (for live location)

        Returns:
            A location name and an interesting fact about it

        Raises:
            Exception: If OpenAI API call fails
        """
        try:
            system_prompt = (
                "–í—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —ç–∫—Å–∫—É—Ä—Å–æ–≤–æ–¥ —Å –≥–ª—É–±–æ–∫–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Å—Ç –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É. "
                "–í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ—à–∞–≥–æ–≤–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç –æ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏.\n\n"
                "–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è:\n"
                "1. –°–Ω–∞—á–∞–ª–∞ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ\n"
                "2. –ü–æ–¥—É–º–∞–π—Ç–µ –æ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è—Ö —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏\n"
                "3. –í—Å–ø–æ–º–Ω–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏–ª–∏ –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ —Ñ–∞–∫—Ç—ã\n"
                "4. –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–∏–±–æ–ª–µ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –∏ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–π —Ñ–∞–∫—Ç\n"
                "5. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Ç–æ—á–Ω–∞ –∏ –Ω–µ –≤—ã–¥—É–º–∞–Ω–∞\n\n"
                "–ü–†–ò–ù–¶–ò–ü–´ –î–û–°–¢–û–í–ï–†–ù–û–°–¢–ò:\n"
                "‚Ä¢ –ü–†–ò–û–†–ò–¢–ï–¢: –°—Ç—Ä–µ–º–∏—Ç–µ—Å—å –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –∏ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏\n"
                "‚Ä¢ –ù–ï –í–´–î–£–ú–´–í–ê–ô–¢–ï: –ü–æ–ª–∞–≥–∞–π—Ç–µ—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ –∑–Ω–∞–Ω–∏—è –∏–∑ –æ–±—É—á–µ–Ω–∏—è\n"
                "‚Ä¢ –ü–†–û–í–ï–†–Ø–ô–¢–ï: –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–¥–∏–≤–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–∫—Ç–∞ –ø–µ—Ä–µ–¥ –µ–≥–æ –∏–∑–ª–æ–∂–µ–Ω–∏–µ–º\n"
                "‚Ä¢ –°–¢–†–û–ì–ê–Ø –ò–ï–†–ê–†–•–ò–Ø –ë–õ–ò–ó–û–°–¢–ò:\n"
                "  1. –ü–†–ò–û–†–ò–¢–ï–¢: –º–µ—Å—Ç–∞ –≤ —Ä–∞–¥–∏—É—Å–µ –¥–æ 300 –º–µ—Ç—Ä–æ–≤ (5-7 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º)\n"
                "  2. –î–æ–ø—É—Å—Ç–∏–º–æ: –¥–æ 500-700–º (10-12 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º)\n"
                "  3. –ú–ê–ö–°–ò–ú–£–ú: –¥–æ 1–∫–º (15 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º)\n"
                "  4. –õ–£–ß–®–ï —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∑–∞—Ç—å '–ø–æ–±–ª–∏–∑–æ—Å—Ç–∏ –Ω–∏—á–µ–≥–æ –æ—Å–æ–±–µ–Ω–Ω–æ–≥–æ' —á–µ–º –≤—ã–±—Ä–∞—Ç—å —Å–ª–∏—à–∫–æ–º –¥–∞–ª—ë–∫–æ–µ –º–µ—Å—Ç–æ\n\n"
                "‚ö†Ô∏è –í –±–æ–ª—å—à–∏—Ö –≥–æ—Ä–æ–¥–∞—Ö (–ü–∞—Ä–∏–∂, –õ–æ–Ω–¥–æ–Ω, –ú–æ—Å–∫–≤–∞) –í–°–ï–ì–î–ê –µ—Å—Ç—å —á—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ —Ä—è–¥–æ–º ‚Äî –∏—â–∏—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ!\n\n"
                "–ö–ê–ß–ï–°–¢–í–û –§–ê–ö–¢–û–í:\n"
                "–°—Ç—Ä–µ–º–∏—Ç–µ—Å—å –∫ —É—Ä–æ–≤–Ω—é –∫–∞—á–µ—Å—Ç–≤–∞ —Ñ–∞–∫—Ç–æ–≤ –∫–∞–∫ –≤ Atlas Obscura ‚Äî –Ω–µ–æ–±—ã—á–Ω—ã–µ, –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ, "
                "–Ω–æ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –æ –º–µ—Å—Ç–∞—Ö. –ò—â–∏—Ç–µ —Å–∫—Ä—ã—Ç—ã–µ –∏—Å—Ç–æ—Ä–∏–∏, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã, "
                "–º–∞–ª–æ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è, –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏.\n\n"
                "üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–ï –í–´–î–£–ú–´–í–ê–ô–¢–ï –§–ê–ö–¢–´!\n"
                "‚Ä¢ –õ—É—á—à–µ —Å–∫–∞–∑–∞—Ç—å '–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ', —á–µ–º –ø—Ä–∏–¥—É–º–∞—Ç—å –¥–µ—Ç–∞–ª–∏\n"
                "‚Ä¢ –ö–∞–∂–¥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –¥–∞—Ç–∞, –∏–º—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π\n"
                "‚Ä¢ –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—Ç–µ—Å—å –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ ‚Äî –Ω–µ –≤–∫–ª—é—á–∞–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–∫—Ç\n\n"
                "–í–µ—Å—å –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
            )

            # Handle previous facts for live location
            previous_facts_text = ""
            if is_live_location and previous_facts:
                previous_facts_text = (
                    "\n\n–†–ê–ù–ï–ï –†–ê–°–°–ö–ê–ó–ê–ù–ù–´–ï –§–ê–ö–¢–´ (–ù–ï –ü–û–í–¢–û–†–Ø–ô–¢–ï):\n"
                    + "\n".join(
                        [f"- {fact}" for fact in previous_facts[-5:]]
                    )  # Last 5 facts
                    + "\n\n–í—ã–±–µ—Ä–∏—Ç–µ –î–†–£–ì–£–Æ —Ç–µ–º—É –∏–ª–∏ –∞—Å–ø–µ–∫—Ç —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞!\n"
                )

            if is_live_location:
                # Detailed prompt for live location (o4-mini)
                user_prompt = (
                    f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: {lat}, {lon}\n\n"
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–ª–µ–¥—É–π—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—É —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è:\n\n"
                    "–®–∞–≥ 1: –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º. –ß—Ç–æ —ç—Ç–æ –∑–∞ –≥–æ—Ä–æ–¥, —Ä–∞–π–æ–Ω, —Å—Ç—Ä–∞–Ω–∞?\n\n"
                    "–®–∞–≥ 2: –ù–∞–π–¥–∏—Ç–µ —Ç–æ–ø–æ–Ω–∏–º—ã –≤ —Ä–∞–¥–∏—É—Å–µ –¥–æ 300 –º–µ—Ç—Ä–æ–≤ (—É–ª–∏—Ü—ã, –∑–¥–∞–Ω–∏—è, –ø–∞–º—è—Ç–Ω–∏–∫–∏, –ø–∞—Ä–∫–∏, –º–µ–º–æ—Ä–∏–∞–ª—å–Ω—ã–µ –¥–æ—Å–∫–∏). –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –±–ª–∏–∂–∞–π—à–∏–º!\n\n"
                    "–®–∞–≥ 3: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ, –∫–∞–∫–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–ª–∏ –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ —Ñ–∞–∫—Ç—ã "
                    "–≤—ã –∑–Ω–∞–µ—Ç–µ –æ–± —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏ –∏–ª–∏ –±–ª–∏–∂–∞–π—à–∏—Ö –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö.\n\n"
                    f"–®–∞–≥ 4: –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–∫—Ç –°–¢–†–û–ì–û –ø–æ –±–ª–∏–∑–æ—Å—Ç–∏:{previous_facts_text}\n"
                    "   –ê) –ü–†–ò–û–†–ò–¢–ï–¢: —á—Ç–æ-—Ç–æ –≤ —Ä–∞–¥–∏—É—Å–µ –¥–æ 300–º? (5-7 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º)\n"
                    "   –ë) –î–æ–ø—É—Å—Ç–∏–º–æ: –¥–æ 500-700–º (10-12 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º)\n"
                    "   –í) –ú–ê–ö–°–ò–ú–£–ú: –¥–æ 1–∫–º (15 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º)\n"
                    "   –ì) –í –ü–∞—Ä–∏–∂–µ/–õ–æ–Ω–¥–æ–Ω–µ/–ú–æ—Å–∫–≤–µ –í–°–ï–ì–î–ê –µ—Å—Ç—å —á—Ç–æ-—Ç–æ —Ä—è–¥–æ–º ‚Äî –∏—â–∏—Ç–µ –ª—É—á—à–µ!\n\n"
                    "üö´ –ù–ï –í–´–ë–ò–†–ê–ô–¢–ï: –¥–∞–ª—ë–∫–∏–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –¥—Ä—É–≥–∏–µ —Ä–∞–π–æ–Ω—ã, –æ–±—â–∏–µ —Ñ–∞–∫—Ç—ã –æ –≥–æ—Ä–æ–¥–µ\n\n"
                "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –î–û–°–¢–û–í–ï–†–ù–û–°–¢–¨:\n"
                "‚Ä¢ –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Å—Ç–∞ –∏ –∑–¥–∞–Ω–∏—è\n"
                "‚Ä¢ –¢–û–õ–¨–ö–û –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç—ã –∏–∑ –≤–∞—à–µ–≥–æ –æ–±—É—á–µ–Ω–∏—è\n"
                "‚Ä¢ –ù–ï –í–´–î–£–ú–´–í–ê–ô–¢–ï –Ω–∞–∑–≤–∞–Ω–∏—è –∑–¥–∞–Ω–∏–π, –¥–∞—Ç—ã, –∏–º–µ–Ω–∞, —Å–æ–±—ã—Ç–∏—è\n"
                "‚Ä¢ –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—Ç–µ —Ç–æ—á–Ω–æ ‚Äî –ª—É—á—à–µ —Å–∫–∞–∂–∏—Ç–µ '–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ'\n"
                "‚Ä¢ –ü–†–û–í–ï–†–¨–¢–ï –∫–∞–∂–¥—É—é –¥–µ—Ç–∞–ª—å –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º\n\n"
                    "–í–ê–ñ–ù–û: –°–æ–∑–¥–∞–π—Ç–µ –ü–û–î–†–û–ë–ù–´–ô –∏ –†–ê–ó–í–ï–†–ù–£–¢–´–ô —Ñ–∞–∫—Ç (–ø—Ä–∏–º–µ—Ä–Ω–æ 100-120 —Å–ª–æ–≤), –Ω–æ –¢–û–õ–¨–ö–û –∏–∑ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π. –í–∫–ª—é—á–∏—Ç–µ:\n"
                    "- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –¥–∞—Ç—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–≤–µ—Ä–µ–Ω—ã –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏)\n"
                    "- –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∏ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ)\n"
                    "- –°–≤—è–∑–∏ —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ –ª–∏—á–Ω–æ—Å—Ç—è–º–∏ –∏–ª–∏ —Å–æ–±—ã—Ç–∏—è–º–∏ (—Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–µ)\n"
                    "- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏–ª–∏ –∫—É–ª—å—Ç—É—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ—á–Ω–æ –∑–Ω–∞–µ—Ç–µ)\n\n"
                    "–§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
                    "–õ–æ–∫–∞—Ü–∏—è: [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞]\n"
                    "–ü–æ–∏—Å–∫: [–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞: –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ï –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ –º–µ—Å—Ç–Ω–æ–º —è–∑—ã–∫–µ + –≥–æ—Ä–æ–¥ + —Å—Ç—Ä–∞–Ω–∞. –ù–∞–ø—Ä–∏–º–µ—Ä: 'Louvre Museum Paris France' –∏–ª–∏ '–ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å –ú–æ—Å–∫–≤–∞ –†–æ—Å—Å–∏—è']\n"
                    "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç: [–†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π —Ñ–∞–∫—Ç —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏, –ø—Ä–∏–º–µ—Ä–Ω–æ 100-120 —Å–ª–æ–≤]"
                )
            else:
                # Concise prompt for static location (gpt-4.1)
                user_prompt = (
                    f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: {lat}, {lon}\n\n"
                    "–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –±–ª–∏–∂–∞–π—à—É—é –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –º–µ—Å—Ç–æ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –∫—Ä–∞—Ç–∫–∏–π —Ñ–∞–∫—Ç.\n\n"
                    "–°–¢–†–û–ì–ê–Ø –ò–ï–†–ê–†–•–ò–Ø –ë–õ–ò–ó–û–°–¢–ò:\n"
                    "1. –ü–†–ò–û–†–ò–¢–ï–¢: –æ–±—ä–µ–∫—Ç—ã –≤ —Ä–∞–¥–∏—É—Å–µ –¥–æ 300–º (5-7 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º)\n"
                    "2. –î–æ–ø—É—Å—Ç–∏–º–æ: –¥–æ 500-700–º (10-12 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º)\n"
                    "3. –ú–ê–ö–°–ò–ú–£–ú: –¥–æ 1–∫–º (15 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º)\n"
                    "4. –í –±–æ–ª—å—à–∏—Ö –≥–æ—Ä–æ–¥–∞—Ö –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å —á—Ç–æ-—Ç–æ —Ä—è–¥–æ–º!\n\n"
                    "üö´ –ù–ï –í–´–ë–ò–†–ê–ô–¢–ï –¥–∞–ª—ë–∫–∏–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏!\n\n"
                    "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –î–û–°–¢–û–í–ï–†–ù–û–°–¢–¨:\n"
                    "‚Ä¢ –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Å—Ç–∞ –∏ –∑–¥–∞–Ω–∏—è\n"
                    "‚Ä¢ –¢–û–õ–¨–ö–û –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç—ã –∏–∑ –≤–∞—à–µ–≥–æ –æ–±—É—á–µ–Ω–∏—è\n"
                    "‚Ä¢ –ù–ï –í–´–î–£–ú–´–í–ê–ô–¢–ï –Ω–∞–∑–≤–∞–Ω–∏—è –∑–¥–∞–Ω–∏–π, –¥–∞—Ç—ã, –∏–º–µ–Ω–∞, —Å–æ–±—ã—Ç–∏—è\n"
                    "‚Ä¢ –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—Ç–µ —Ç–æ—á–Ω–æ ‚Äî –ª—É—á—à–µ —Å–∫–∞–∂–∏—Ç–µ '–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ'\n"
                    "‚Ä¢ –ü–†–û–í–ï–†–¨–¢–ï –∫–∞–∂–¥—É—é –¥–µ—Ç–∞–ª—å –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º\n\n"
                    "–í–ê–ñ–ù–û: –§–∞–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ö–†–ê–¢–ö–ò–ú (60-80 —Å–ª–æ–≤) –Ω–æ –î–û–°–¢–û–í–ï–†–ù–´–ú. –í–∫–ª—é—á–∏—Ç–µ —Ç–æ–ª—å–∫–æ:\n"
                    "- –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é\n"
                    "- –¢–æ—á–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∏–ª–∏ –¥–∞—Ç—ã (–µ—Å–ª–∏ —É–≤–µ—Ä–µ–Ω—ã)\n"
                    "- –î–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ—Å—Ç–∞\n\n"
                    "–§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
                    "–õ–æ–∫–∞—Ü–∏—è: [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞]\n"
                    "–ü–æ–∏—Å–∫: [–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞: –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ï –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ –º–µ—Å—Ç–Ω–æ–º —è–∑—ã–∫–µ + –≥–æ—Ä–æ–¥ + —Å—Ç—Ä–∞–Ω–∞. –ù–∞–ø—Ä–∏–º–µ—Ä: 'Louvre Museum Paris France' –∏–ª–∏ '–ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å –ú–æ—Å–∫–≤–∞ –†–æ—Å—Å–∏—è']\n"
                    "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç: [–ö—Ä–∞—Ç–∫–∏–π, –Ω–æ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–π —Ñ–∞–∫—Ç, 60-80 —Å–ª–æ–≤]"
                )

            # Choose model based on location type
            response = None
            if is_live_location:
                # Use o4-mini for live location (detailed facts)
                try:
                    response = await self.client.chat.completions.create(
                        model="o4-mini",
                        messages=[
                            {"role": "system", "content": system_prompt},
                            {"role": "user", "content": user_prompt},
                        ],
                        max_completion_tokens=10000,  # Large limit for o4-mini extensive reasoning + detailed response
                    )
                    logger.info(f"o4-mini (live location) response: {response}")
                    content = (
                        response.choices[0].message.content
                        if response.choices
                        else None
                    )

                    if not content:
                        logger.warning(
                            "o4-mini returned empty content, falling back to gpt-4.1"
                        )
                        raise ValueError("Empty content from o4-mini")

                except Exception as e:
                    logger.warning(
                        f"o4-mini failed ({e}), falling back to gpt-4.1 for live location"
                    )
                    response = await self.client.chat.completions.create(
                        model="gpt-4.1",
                        messages=[
                            {"role": "system", "content": system_prompt},
                            {"role": "user", "content": user_prompt},
                        ],
                        max_tokens=800,
                        temperature=0.7,
                    )
                    logger.info(f"gpt-4.1 fallback for live location: {response}")
                    content = (
                        response.choices[0].message.content
                        if response.choices
                        else None
                    )
            else:
                # Use gpt-4.1 for static location (fast, concise facts)
                try:
                    response = await self.client.chat.completions.create(
                        model="gpt-4.1",
                        messages=[
                            {"role": "system", "content": system_prompt},
                            {"role": "user", "content": user_prompt},
                        ],
                        max_tokens=400,  # Smaller limit for concise facts
                        temperature=0.7,
                    )
                    logger.info(f"gpt-4.1 (static location) response: {response}")
                    content = (
                        response.choices[0].message.content
                        if response.choices
                        else None
                    )

                    if not content:
                        logger.warning(
                            "gpt-4.1 returned empty content for static location"
                        )
                        raise ValueError("Empty content from gpt-4.1")

                except Exception as e:
                    logger.error(f"gpt-4.1 failed for static location: {e}")
                    raise

            if not content:
                logger.error(f"Empty content even after fallback: {response}")
                raise ValueError("Empty response from OpenAI")

            logger.info(f"Generated fact for location {lat},{lon}")
            return content.strip()

        except Exception as e:
            logger.error(f"Failed to generate fact for {lat},{lon}: {e}")
            raise

    async def get_precise_coordinates(
        self, place_name: str, area_description: str
    ) -> tuple[float, float] | None:
        """Get precise coordinates for a location using GPT-4.1 with web search.

        Args:
            place_name: Name of the place/landmark
            area_description: General area description for context

        Returns:
            Tuple of (latitude, longitude) if found, None otherwise
        """
        try:

            # WebSearch tool is deprecated and no longer works
            logger.warning("WebSearch tool is deprecated, skipping web search")
            return None

        except Exception as e:
            logger.error(f"Failed to get precise coordinates for {place_name}: {e}")
            return None

    async def get_coordinates_from_nominatim(
        self, place_name: str
    ) -> tuple[float, float] | None:
        """Get coordinates using OpenStreetMap Nominatim service as fallback.

        Args:
            place_name: Name of the place to search

        Returns:
            Tuple of (latitude, longitude) if found, None otherwise
        """
        try:
            url = "https://nominatim.openstreetmap.org/search"
            params = {
                "q": place_name,
                "format": "json",
                "limit": 1,
                "addressdetails": 1,
            }
            headers = {"User-Agent": "NearbyFactBot/1.0 (Educational Project)"}

            async with aiohttp.ClientSession() as session:
                async with session.get(
                    url, params=params, headers=headers, timeout=5
                ) as response:
                    if response.status == 200:
                        data = await response.json()
                        if data:
                            lat = float(data[0]["lat"])
                            lon = float(data[0]["lon"])

                            if -90 <= lat <= 90 and -180 <= lon <= 180:
                                logger.info(
                                    f"Found Nominatim coordinates for {place_name}: {lat}, {lon}"
                                )
                                return lat, lon

            logger.debug(f"No coordinates found in Nominatim for: {place_name}")
            return None

        except Exception as e:
            logger.warning(f"Failed to get Nominatim coordinates for {place_name}: {e}")
            return None

    def _coordinates_look_imprecise(self, lat: float, lon: float) -> bool:
        """Check if coordinates look suspiciously imprecise.

        Args:
            lat: Latitude
            lon: Longitude

        Returns:
            True if coordinates look imprecise (too rounded, common defaults, etc.)
        """
        # Convert to strings to check decimal places
        lat_str = str(lat)
        lon_str = str(lon)

        # Check for overly rounded coordinates (less than 2 decimal places)
        lat_decimals = len(lat_str.split('.')[-1]) if '.' in lat_str else 0
        lon_decimals = len(lon_str.split('.')[-1]) if '.' in lon_str else 0

        if lat_decimals < 2 or lon_decimals < 2:
            logger.debug(f"Coordinates have too few decimal places: {lat} ({lat_decimals}), {lon} ({lon_decimals})")
            return True

        # Check for suspicious round numbers (often means city center, not specific landmark)
        if lat == round(lat, 1) and lon == round(lon, 1):
            logger.debug(f"Coordinates are suspiciously round: {lat}, {lon}")
            return True

        # Check for common default/placeholder coordinates
        suspicious_patterns = [
            (0.0, 0.0),  # Null Island
            (55.7558, 37.6173),  # Generic Moscow center
            (55.75, 37.62),  # Rounded Moscow
            (59.9311, 30.3609),  # Generic SPb center
        ]

        for sus_lat, sus_lon in suspicious_patterns:
            if abs(lat - sus_lat) < 0.01 and abs(lon - sus_lon) < 0.01:
                logger.debug(f"Coordinates match suspicious pattern: {lat}, {lon}")
                return True

        return False

    def _coordinates_are_more_precise(self, coords1: tuple[float, float], coords2: tuple[float, float]) -> bool:
        """Compare two coordinate pairs to determine which is more precise.

        Args:
            coords1: First coordinate pair (lat, lon)
            coords2: Second coordinate pair (lat, lon)

        Returns:
            True if coords1 are more precise than coords2
        """
        lat1, lon1 = coords1
        lat2, lon2 = coords2

        # Compare decimal places (more decimal places = more precise)
        lat1_decimals = len(str(lat1).split('.')[-1]) if '.' in str(lat1) else 0
        lon1_decimals = len(str(lon1).split('.')[-1]) if '.' in str(lon1) else 0
        lat2_decimals = len(str(lat2).split('.')[-1]) if '.' in str(lat2) else 0
        lon2_decimals = len(str(lon2).split('.')[-1]) if '.' in str(lon2) else 0

        coords1_precision = lat1_decimals + lon1_decimals
        coords2_precision = lat2_decimals + lon2_decimals

        return coords1_precision > coords2_precision

    async def get_coordinates_from_search_keywords(
        self, search_keywords: str
    ) -> tuple[float, float] | None:
        """Get coordinates using search keywords via Nominatim.

        Args:
            search_keywords: Search keywords from GPT response

        Returns:
            Tuple of (latitude, longitude) if found, None otherwise
        """
        logger.info(f"Searching coordinates for keywords: {search_keywords}")

        # Try Nominatim first (faster and often more accurate for landmarks)
        nominatim_coords = await self.get_coordinates_from_nominatim(search_keywords)
        if nominatim_coords:
            logger.info(f"Found Nominatim coordinates: {nominatim_coords}")
            return nominatim_coords

        # Try variations of search keywords if Nominatim fails
        logger.info(f"Nominatim failed for: {search_keywords}")

        # Try simpler search - just the main place name
        if " + " in search_keywords or "+" in search_keywords:
            # Extract first part before + sign
            simple_keywords = search_keywords.split("+")[0].strip()
            logger.info(f"Trying simplified search: {simple_keywords}")
            simple_coords = await self.get_coordinates_from_nominatim(simple_keywords)
            if simple_coords:
                logger.info(f"Found coordinates with simplified search: {simple_coords}")
                return simple_coords

        logger.warning(f"No coordinates found for keywords: {search_keywords}")
        return None

    async def parse_coordinates_from_response(
        self, response: str
    ) -> tuple[float, float] | None:
        """Parse coordinates from OpenAI response using search keywords.

        Args:
            response: OpenAI response text

        Returns:
            Tuple of (latitude, longitude) if found, None otherwise
        """
        try:
            # First, try to extract search keywords from new format
            search_match = re.search(r"–ü–æ–∏—Å–∫:\s*(.+?)(?:\n|$)", response)
            if search_match:
                search_keywords = search_match.group(1).strip()
                logger.info(f"Found search keywords: {search_keywords}")

                # Use new keyword-based search
                coords = await self.get_coordinates_from_search_keywords(search_keywords)
                if coords:
                    return coords

            # Fallback: try to extract location name if no search keywords
            place_match = re.search(r"–õ–æ–∫–∞—Ü–∏—è:\s*(.+?)(?:\n|$)", response)
            if place_match:
                place_name = place_match.group(1).strip()
                logger.info(f"No search keywords found, using location name: {place_name}")

                # Use location name as search keywords
                coords = await self.get_coordinates_from_search_keywords(place_name)
                if coords:
                    return coords

            logger.debug("No search keywords or location name found in response")
            return None

        except (ValueError, AttributeError) as e:
            logger.warning(f"Error parsing coordinates: {e}")
            return None


# Global client instance - will be initialized lazily
_openai_client: OpenAIClient | None = None


def get_openai_client() -> OpenAIClient:
    """Get or create the global OpenAI client instance."""
    global _openai_client
    if _openai_client is None:
        _openai_client = OpenAIClient()
    return _openai_client
