# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–∫—Ç–æ–≤ (v1.3.3)

## üìÖ –î–∞—Ç–∞: 28 –Ω–æ—è–±—Ä—è 2025

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –∂–∏–≤–æ–π –ª–æ–∫–∞—Ü–∏–∏ (live location) –±–æ—Ç –≤—ã–¥–∞–≤–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–æ–≤ –ø—Ä–æ **–æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –º–µ—Å—Ç–æ**, —Ö–æ—Ç—è –¥–æ–ª–∂–µ–Ω –±—ã–ª –Ω–∞—Ö–æ–¥–∏—Ç—å —Ä–∞–∑–Ω—ã–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

### –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ

1. **AI –Ω–∞–∑—ã–≤–∞–ª –æ–¥–Ω–æ –º–µ—Å—Ç–æ –ø–æ-—Ä–∞–∑–Ω–æ–º—É**:
   - "√âglise Saint-Eustache"
   - "Church of Saint-Eustache, Paris"
   - "Saint-Eustache"
   
2. **–ù–µ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã** –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Python ‚Äî –∫–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–ª–∞–≥–∞–ª—Å—è –Ω–∞ AI.

3. **–í –ø—Ä–æ–º–ø—Ç –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Ñ–∞–∫—Ç–∞**, –∞ –Ω–µ —è–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–µ—Å—Ç –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –º–µ—Å—Ç

–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `normalize_place_name()` –≤ `formatting_utils.py`:

```python
# –ü—Ä–∏–º–µ—Ä—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:
"√âglise Saint-Eustache"     ‚Üí "saint eustache"
"Church of Saint-Eustache"  ‚Üí "saint eustache"
"Tour Eiffel"               ‚Üí "eiffel"
"Eiffel Tower"              ‚Üí "eiffel"
"Mus√©e du Louvre"           ‚Üí "louvre"
"The Louvre Museum"         ‚Üí "louvre"
```

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è:
- –§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π, –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, —Ä—É—Å—Å–∫–∏–π, –Ω–µ–º–µ—Ü–∫–∏–π, –∏—Å–ø–∞–Ω—Å–∫–∏–π, –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π —è–∑—ã–∫–∏
- –£–¥–∞–ª–µ–Ω–∏–µ –∞—Ä—Ç–∏–∫–ª–µ–π, –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ —Ç–∏–ø–æ–≤ –º–µ—Å—Ç (—Ü–µ—Ä–∫–æ–≤—å, –º—É–∑–µ–π, –¥–≤–æ—Ä–µ—Ü)
- –ö—Ä–æ—Å—Å-—è–∑—ã–∫–æ–≤—ã–µ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—ã –¥–ª—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã

–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `is_duplicate_place()`:
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (‚â•70% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ = –¥—É–±–ª–∏–∫–∞—Ç)
- –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–¥—Å—Ç—Ä–æ–∫–∏ (Saint-Eustache ‚äÇ √âglise Saint-Eustache)

### 3. Retry –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö

–í `live_location_tracker.py` –¥–æ–±–∞–≤–ª–µ–Ω —Ü–∏–∫–ª retry:

```python
for duplicate_retry in range(MAX_DUPLICATE_RETRIES + 1):
    # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–∫—Ç –æ—Ç AI
    response = await openai_client.get_nearby_fact(...)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
    if is_duplicate_place(place, previous_place_names):
        if duplicate_retry < MAX_DUPLICATE_RETRIES:
            # –ü–æ–≤—Ç–æ—Ä—è–µ–º —Å —É—Å–∏–ª–µ–Ω–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
            continue
        else:
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª
            break
    else:
        # –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
        break
```

### 4. –£—Å–∏–ª–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ –ø—Ä–æ–º–ø—Ç–µ

–í `openai_client.py` –æ–±–Ω–æ–≤–ª—ë–Ω `_build_location_fact_prompt()`:

```python
‚õî FORBIDDEN PLACES (DO NOT USE - find a DIFFERENT location!):
"√âglise Saint-Eustache", "Louvre Museum"

CRITICAL DUPLICATE PREVENTION:
- You MUST choose a COMPLETELY DIFFERENT place than any listed above
- Do NOT mention the same building/monument/location with a different name
- Even if a famous landmark is nearby, pick a DIFFERENT, lesser-known spot
```

## üìÅ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`src/utils/formatting_utils.py`**:
   - `normalize_place_name()` ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π
   - `is_duplicate_place()` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
   - `extract_place_names_from_history()` ‚Äî –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏

2. **`src/services/live_location_tracker.py`**:
   - –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `MAX_DUPLICATE_RETRIES = 2`
   - –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω —Ü–∏–∫–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–∫—Ç–æ–≤ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

3. **`src/services/openai_client.py`**:
   - –£—Å–∏–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ `_build_location_fact_prompt()`
   - –î–æ–±–∞–≤–ª–µ–Ω —è–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö –º–µ—Å—Ç –≤ –ø—Ä–æ–º–ø—Ç

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –¢–µ—Å—Ç—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
python -c "from src.utils.formatting_utils import normalize_place_name, is_duplicate_place
print(normalize_place_name('√âglise Saint-Eustache'))  # 'saint eustache'
print(is_duplicate_place('Eiffel Tower', ['Tour Eiffel']))  # True"

# –¢–µ—Å—Ç—ã live location tracker
python -m pytest tests/test_live_location_tracker.py -v
# 6 passed ‚úì
```

## üöÄ –î–µ–ø–ª–æ–π

```bash
git add .
git commit -m "fix: prevent duplicate places in live location facts"
git push origin main
```

–ó–∞—Ç–µ–º:
```bash
koyeb service redeploy profitable-dita/test-tg-coordinate
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

| –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|---------------|-------------------|
| 3 —Ñ–∞–∫—Ç–∞ –ø—Ä–æ –æ–¥–Ω–æ –º–µ—Å—Ç–æ | –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞ –≤ –∫–∞–∂–¥–æ–º —Ñ–∞–∫—Ç–µ |
| AI –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é | Python-–ø—Ä–æ–≤–µ—Ä–∫–∞ + —É—Å–∏–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç |
| –ù–µ—Ç retry | –î–æ 2 –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç–µ |

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞ –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–∏—Ç—Å—è:

```
WARNING - Duplicate place detected for user 12345: 'Saint-Eustache' (previous: ['√âglise Saint-Eustache'])
INFO - Unique place found for user 12345: 'Les Halles'
```

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ –¥–ª—è –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏—Ö —è–∑—ã–∫–æ–≤
2. –û—á–µ–Ω—å —Ä–µ–¥–∫–∏–µ –º–µ—Å—Ç–∞ –º–æ–≥—É—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å—Å—è –∫–∞–∫ –¥—É–±–ª–∏–∫–∞—Ç—ã
3. –ü—Ä–∏ `MAX_DUPLICATE_RETRIES` –Ω–µ—É–¥–∞—á –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è

---

**–í–µ—Ä—Å–∏—è**: v1.3.3  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

