# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å Koyeb

## –ü—Ä–æ–±–ª–µ–º–∞
Instance Koyeb –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª—Å—è –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è healthcheck endpoint'–∞, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–µ "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞–Ω–Ω–æ–º –º–µ—Å—Ç–µ".

## ‚úÖ –†–µ—à–µ–Ω–∏–µ (–ü–†–ò–ú–ï–ù–ï–ù–û)

–î–æ–±–∞–≤–ª–µ–Ω healthcheck endpoint –≤ `src/main.py`:
- `GET /` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `200 OK`
- `GET /health` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `200 OK`
- `GET /healthz` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `200 OK`

## üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Koyeb

### 1. Healthcheck Configuration

–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Koyeb —Å–µ—Ä–≤–∏—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:
- **Health check path**: `/health` –∏–ª–∏ `/`
- **Port**: —Ç–æ—Ç –∂–µ –ø–æ—Ä—Ç —á—Ç–æ –∏ –≤ `PORT` –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–æ–±—ã—á–Ω–æ `8000`)
- **Protocol**: HTTP
- **Interval**: 30 —Å–µ–∫—É–Ω–¥
- **Timeout**: 5 —Å–µ–∫—É–Ω–¥
- **Unhealthy threshold**: 3
- **Healthy threshold**: 2

### 2. Environment Variables

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ Koyeb –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï
TELEGRAM_BOT_TOKEN=your_bot_token
OPENAI_API_KEY=your_openai_key
WEBHOOK_URL=https://your-app-name.koyeb.app  # –ë–ï–ó /telegram –Ω–∞ –∫–æ–Ω—Ü–µ!
PORT=8000

# –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï
USE_FIRESTORE_DB=true
GOOGLE_CLOUD_PROJECT=your-project-id
# (–∏–ª–∏ Firebase service account JSON –≤ GOOGLE_APPLICATION_CREDENTIALS_JSON)

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–´–ï
YANDEX_API_KEY=your_yandex_key  # –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
YANDEX_FOLDER_ID=your_folder_id
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Webhook

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ webhook —Ä–∞–±–æ—Ç–∞–µ—Ç:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ healthcheck
curl https://your-app-name.koyeb.app/health
# –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: OK

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Telegram webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
curl https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo
```

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
```json
{
  "ok": true,
  "result": {
    "url": "https://your-app-name.koyeb.app/telegram",
    "has_custom_certificate": false,
    "pending_update_count": 0
  }
}
```

### 4. Deployment

1. **Commit –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
   ```bash
   git add src/main.py docs/KOYEB_FIX.md
   git commit -m "fix: add healthcheck endpoint for Koyeb"
   git push origin main
   ```

2. **Koyeb –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ-–∑–∞–¥–µ–ø–ª–æ–∏—Ç** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** –≤ Koyeb dashboard:
   - –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è —Å—Ç—Ä–æ–∫–∞: `Added healthcheck endpoints: /, /health, /healthz`
   - –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è —Å—Ç—Ä–æ–∫–∞: `Starting webhook on port 8000`
   - –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: `Instance is stopping`

### 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram: `@your_bot_username`
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start`
3. –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫
4. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ 5-10 –º–∏–Ω—É—Ç** —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ instance –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
5. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é:
   - üìé ‚Üí Location ‚Üí Send My Current Location
6. –í—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å —Ñ–∞–∫—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏

## üêõ –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: Instance –≤—Å—ë –µ—â—ë –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è?

–°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ Koyeb:
```
Instance is stopping  ‚Üê –≠–¢–û –ü–õ–û–•–û
```

**–†–µ—à–µ–Ω–∏–µ**: 
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ healthcheck –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ `/health`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ—Ä—Ç —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `PORT` –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?

```bash
# –ü–æ–ª—É—á–∏—Ç—å webhook info
curl https://api.telegram.org/bot<TOKEN>/getWebhookInfo
```

–ï—Å–ª–∏ `url` –ø—É—Å—Ç–æ–π:
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook –≤—Ä—É—á–Ω—É—é
curl https://api.telegram.org/bot<TOKEN>/setWebhook?url=https://your-app-name.koyeb.app/telegram
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: OpenAI API –æ—à–∏–±–∫–∏?

–°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç:
```
Failed to generate fact
```

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `OPENAI_API_KEY` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å OpenAI –∞–∫–∫–∞—É–Ω—Ç–∞
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é –≤ –∏–∑–≤–µ—Å—Ç–Ω–æ–º –º–µ—Å—Ç–µ (—Ü–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤—ã, –ü–∞—Ä–∏–∂–∞)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: Firebase/Firestore –æ—à–∏–±–∫–∏?

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ:
```
firebase not configured
```

**–û–ø—Ü–∏–∏**:
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Firebase (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production)
2. –ò–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å: —É–¥–∞–ª–∏—Ç—å `USE_FIRESTORE_DB` –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

## üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: Railway

–ï—Å–ª–∏ Koyeb –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ Railway:

1. Railway –∏–º–µ–µ—Ç –ª—É—á—à—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É Python –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π healthcheck –±–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
3. –ë–æ–ª–µ–µ —â–µ–¥—Ä—ã–π free tier –¥–ª—è hobby –ø—Ä–æ–µ–∫—Ç–æ–≤

–°–º. `docs/RAILWAY_OPTIMIZATION_PLAN.md` –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏.

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –≤ Koyeb:
- **Uptime**: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–ª–∏–∑–æ–∫ –∫ 100%
- **Restarts**: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0 (–∏–ª–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è)
- **Health checks**: –≤—Å–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å–ø–µ—à–Ω—ã–º–∏ (–∑–µ–ª—ë–Ω—ã–µ)

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è

- [ ] Healthcheck endpoint –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–¥
- [ ] –ö–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω –Ω–∞ Koyeb
- [ ] Healthcheck –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Koyeb UI
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "Added healthcheck endpoints"
- [ ] Instance –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 5-10 –º–∏–Ω—É—Ç
- [ ] Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ `/start`
- [ ] –ë–æ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∞–∫—Ç—ã –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é

## üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞:
1. –°–æ–±–µ—Ä–∏—Ç–µ –ø–æ–ª–Ω—ã–µ –ª–æ–≥–∏ –∏–∑ Koyeb
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `getWebhookInfo` output
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å ngrok –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

